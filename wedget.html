<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CP3 Workflow Trigger</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        padding: 20px;
        background-color: #f7f7f5;
        margin: 0;
      }
      .container {
        max-width: 450px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      h2 {
        color: #37352f;
        margin-bottom: 10px;
        font-size: 24px;
      }
      .subtitle {
        color: #787774;
        font-size: 14px;
        margin-bottom: 25px;
      }
      .form-group {
        margin-bottom: 20px;
      }
      label {
        display: block;
        margin-bottom: 8px;
        color: #37352f;
        font-weight: 500;
        font-size: 14px;
      }
      .label-description {
        color: #787774;
        font-size: 12px;
        font-weight: normal;
        margin-top: 2px;
      }
      input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #e1e1e0;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.2s;
        box-sizing: border-box;
      }
      input:focus {
        outline: none;
        border-color: #2ecc71;
      }
      .button-group {
        display: flex;
        gap: 10px;
        margin-top: 30px;
      }
      button {
        flex: 1;
        padding: 12px 24px;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }
      .execute-btn {
        background-color: #2ecc71;
        color: white;
        flex: 2;
      }
      .execute-btn:hover {
        background-color: #27ae60;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(46, 204, 113, 0.3);
      }
      .execute-btn:disabled {
        background-color: #95a5a6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .clear-btn {
        background-color: #ecf0f1;
        color: #7f8c8d;
        flex: 1;
      }
      .clear-btn:hover {
        background-color: #bdc3c7;
      }
      .status {
        margin-top: 20px;
        padding: 15px;
        border-radius: 4px;
        display: none;
        font-size: 14px;
      }
      .status.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .status.loading {
        background-color: #cce5ff;
        color: #004085;
        border: 1px solid #b8daff;
      }
      .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 8px;
        vertical-align: middle;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .divider {
        height: 1px;
        background-color: #e1e1e0;
        margin: 25px 0;
      }
      .info-box {
        background-color: #f7f7f5;
        border: 1px solid #e1e1e0;
        border-radius: 4px;
        padding: 12px;
        margin-bottom: 20px;
        font-size: 13px;
        color: #37352f;
      }
      .info-box strong {
        color: #2ecc71;
      }
      .check-list {
        background-color: #f0f7ff;
        border: 1px solid #d0e3ff;
        border-radius: 4px;
        padding: 15px;
        margin-top: 20px;
        font-size: 13px;
      }
      .check-list h4 {
        margin: 0 0 10px 0;
        color: #1a5490;
        font-size: 14px;
      }
      .check-list ul {
        margin: 0;
        padding-left: 20px;
        color: #37352f;
      }
      .check-list li {
        margin-bottom: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>é–‹ç™ºè¨ˆç”»ä½œæˆãƒ•ãƒ­ãƒ¼</h2>
      <p class="subtitle">Notionãƒ»GitHubã¸ã‚¿ã‚¹ã‚¯ã‚’è‡ªå‹•ç™»éŒ²ã—ã¾ã™</p>

      <div class="info-box">
        ğŸ’¡
        <strong>é–‹å§‹å‰ã«ç¢ºèª:</strong>
        è¨­è¨ˆæ›¸ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„
      </div>

      <div class="form-group">
        <label for="projectId">
          ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID
          <div class="label-description">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è­˜åˆ¥ID</div>
        </label>
        <input
          type="text"
          id="projectId"
          placeholder="ä¾‹: PROJ-2024-001"
          value=""
        />
      </div>

      <div class="form-group">
        <label for="designDocsDbId">
          è¨­è¨ˆæ›¸ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ID
          <div class="label-description">
            æ©Ÿèƒ½è¦ä»¶ä¸€è¦§ãƒ»ç”»é¢ä¸€è¦§ãƒ»APIä¸€è¦§ãƒ»ãƒãƒƒãƒä¸€è¦§ã‚’æ ¼ç´ã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ID
          </div>
        </label>
        <input
          type="text"
          id="designDocsDbId"
          placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
          value=""
        />
      </div>

      <div class="form-group">
        <label for="taskDbId">
          ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ID
          <div class="label-description">
            ã‚¿ã‚¹ã‚¯ã‚’ç™»éŒ²ã™ã‚‹å…ˆã®Notionãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ID
          </div>
        </label>
        <input
          type="text"
          id="taskDbId"
          placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
          value=""
        />
      </div>

      <div class="check-list">
        <h4>ğŸ“‹ å®Ÿè¡Œå‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h4>
        <ul>
          <li>æ©Ÿèƒ½è¦ä»¶ä¸€è¦§ãŒè¨­è¨ˆæ›¸DBã«å­˜åœ¨ã™ã‚‹</li>
          <li>ç”»é¢ä¸€è¦§ãŒè¨­è¨ˆæ›¸DBã«å­˜åœ¨ã™ã‚‹</li>
          <li>APIä¸€è¦§ãŒè¨­è¨ˆæ›¸DBã«å­˜åœ¨ã™ã‚‹</li>
          <li>ãƒãƒƒãƒä¸€è¦§ãŒè¨­è¨ˆæ›¸DBã«å­˜åœ¨ã™ã‚‹</li>
          <li>ã‚¿ã‚¹ã‚¯DBãŒä½œæˆæ¸ˆã¿ã§é©åˆ‡ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹</li>
        </ul>
      </div>

      <div class="button-group">
        <button class="clear-btn" onclick="clearForm()">ã‚¯ãƒªã‚¢</button>
        <button class="execute-btn" onclick="executeWorkflow()">
          <span id="btnText">ã‚¿ã‚¹ã‚¯ç™»éŒ²ã‚’å®Ÿè¡Œ</span>
        </button>
      </div>

      <div id="status" class="status"></div>
    </div>

    <script>
      // åŸ‹ã‚è¾¼ã¿Webhook URLï¼ˆç’°å¢ƒã«å¿œã˜ã¦å¤‰æ›´ã—ã¦ãã ã•ã„ï¼‰
      const WEBHOOK_URL ="https://shotawatanabe777.app.n8n.cloud/webhook/d255365d-693e-4826-99b2-3a7ee93fdfc6"
        // "https://shotawatanabe777.app.n8n.cloud/webhook-test/d255365d-693e-4826-99b2-3a7ee93fdfc6";

      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ä¿å­˜ã•ã‚ŒãŸå€¤ã‚’èª­ã¿è¾¼ã‚€
      window.onload = function () {
        const fields = ["projectId", "designDocsDbId", "taskDbId"];
        fields.forEach((field) => {
          const saved = localStorage.getItem(`cp3_${field}`);
          if (saved) {
            document.getElementById(field).value = saved;
          }
        });
      };

      // å€¤ã‚’ä¿å­˜ã™ã‚‹
      function saveValues() {
        const fields = ["projectId", "designDocsDbId", "taskDbId"];
        fields.forEach((field) => {
          const value = document.getElementById(field).value;
          if (value) {
            localStorage.setItem(`cp3_${field}`, value);
          }
        });
      }

      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
      function clearForm() {
        const fields = ["projectId", "designDocsDbId", "taskDbId"];
        fields.forEach((field) => {
          document.getElementById(field).value = "";
          localStorage.removeItem(`cp3_${field}`);
        });
        hideStatus();
      }

      function showStatus(message, type) {
        const statusDiv = document.getElementById("status");
        statusDiv.className = `status ${type}`;
        if (type === "loading") {
          statusDiv.innerHTML = '<span class="spinner"></span>' + message;
        } else {
          statusDiv.innerHTML = message;
        }
        statusDiv.style.display = "block";

        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯5ç§’å¾Œã«è‡ªå‹•çš„ã«éè¡¨ç¤º
        if (type === "success") {
          setTimeout(() => {
            hideStatus();
          }, 5000);
        }
      }

      function hideStatus() {
        const statusDiv = document.getElementById("status");
        statusDiv.style.display = "none";
      }

      // function validateNotionId(id) {
      //   // Notion IDã®åŸºæœ¬çš„ãªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯ï¼ˆUUIDå½¢å¼ï¼‰
      //   const uuidRegex =
      //     /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
      //   return uuidRegex.test(id);
      // }

      async function executeWorkflow() {
        // å…¥åŠ›å€¤ã‚’å–å¾—
        const projectId = document.getElementById("projectId").value.trim();
        const designDocsDbId = document
          .getElementById("designDocsDbId")
          .value.trim();
        const taskDbId = document.getElementById("taskDbId").value.trim();

        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        if (!projectId) {
          showStatus("âš ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "error");
          return;
        }

        if (!designDocsDbId) {
          showStatus("âš ï¸ è¨­è¨ˆæ›¸ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "error");
          return;
        }

        if (!taskDbId) {
          showStatus("âš ï¸ ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "error");
          return;
        }

        // Notion IDãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        // if (!validateNotionId(designDocsDbId)) {
        //   showStatus(
        //     "âš ï¸ è¨­è¨ˆæ›¸ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹IDã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“",
        //     "error"
        //   );
        //   return;
        // }

        // if (!validateNotionId(taskDbId)) {
        //   showStatus(
        //     "âš ï¸ ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹IDã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“",
        //     "error"
        //   );
        //   return;
        // }

        // å€¤ã‚’ä¿å­˜
        saveValues();

        // å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
        const executeBtn = document.querySelector(".execute-btn");
        const btnText = document.getElementById("btnText");
        executeBtn.disabled = true;
        btnText.textContent = "å‡¦ç†ä¸­...";

        showStatus("ã‚¿ã‚¹ã‚¯ç™»éŒ²å‡¦ç†ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...", "loading");

        const data = {
          projectId: projectId,
          designDocsDatabaseId: designDocsDbId,
          taskDatabaseId: taskDbId,
          cp3ResultId: `CP3-${new Date().toISOString()}`,
          timestamp: new Date().toISOString(),
        };

        try {
          const response = await fetch(WEBHOOK_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          });

          if (response.ok) {
            const result = await response.json();
            showStatus(
              "âœ… ã‚¿ã‚¹ã‚¯ç™»éŒ²ãŒæ­£å¸¸ã«é–‹å§‹ã•ã‚Œã¾ã—ãŸï¼å‡¦ç†å®Œäº†ã¾ã§æ•°åˆ†ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚",
              "success"
            );

            // çµæœã®è©³ç´°ã‚’è¡¨ç¤º
            if (result.taskCount) {
              setTimeout(() => {
                showStatus(
                  `âœ… ç™»éŒ²å®Œäº†: ${result.taskCount}å€‹ã®ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¾ã—ãŸ`,
                  "success"
                );
              }, 2000);
            }
          } else {
            const errorText = await response.text();
            showStatus(
              `âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${response.status} - ${errorText}`,
              "error"
            );
          }
        } catch (error) {
          showStatus(`âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
        } finally {
          // ãƒœã‚¿ãƒ³ã‚’å†åº¦æœ‰åŠ¹åŒ–
          executeBtn.disabled = false;
          btnText.textContent = "ã‚¿ã‚¹ã‚¯ç™»éŒ²ã‚’å®Ÿè¡Œ";
        }
      }

      // Enterã‚­ãƒ¼ã§ã‚‚å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
      document.addEventListener("keypress", function (event) {
        if (event.key === "Enter" && !event.shiftKey) {
          const activeElement = document.activeElement;
          if (activeElement && activeElement.tagName === "INPUT") {
            executeWorkflow();
          }
        }
      });
    </script>
  </body>
</html>
